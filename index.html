<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#e8638c">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="InsulinApp">
<title>InsulinApp üíó</title>
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fdf6f9;
    --surface: #ffffff;
    --surface2: #fef0f5;
    --border: #f5d6e5;
    --accent: #e8638c;
    --accent-light: #f9a8c4;
    --accent2: #b06ab3;
    --accent-soft: #fce4ec;
    --warn: #f4845f;
    --danger: #e85d75;
    --text: #3a2040;
    --text2: #8e6b80;
    --text3: #c9a8bb;
    --grad: linear-gradient(160deg, #e8638c, #b06ab3);
    --shadow: 0 4px 24px rgba(232,99,140,0.12);
    --shadow-card: 0 2px 12px rgba(176,106,179,0.08);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overscroll-behavior: none; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
  }

  /* ===== HEADER ===== */
  .app-header {
    background: var(--grad);
    padding: calc(16px + var(--safe-top)) 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    width: 100%;
    justify-content: center;
  }

  .header-top svg { width: 32px; height: 32px; }

  .app-title {
    font-size: 22px;
    font-weight: 800;
    color: white;
    letter-spacing: -0.3px;
  }

  .insulin-display {
    text-align: center;
    padding: 8px 0 4px;
  }

  .insulin-number {
    font-size: 64px;
    font-weight: 800;
    color: white;
    line-height: 1;
    font-family: 'DM Mono', monospace;
    transition: all 0.3s ease;
  }

  .insulin-label {
    font-size: 12px;
    color: rgba(255,255,255,0.75);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-top: 4px;
  }

  .insulin-placeholder {
    font-size: 16px;
    color: rgba(255,255,255,0.5);
    font-style: italic;
  }

  /* ===== TAB BAR ===== */
  .tab-bar {
    background: white;
    border-top: 1.5px solid var(--border);
    display: flex;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    padding-bottom: var(--safe-bottom);
    z-index: 100;
    box-shadow: 0 -4px 20px rgba(232,99,140,0.08);
  }

  .tab-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 0 8px;
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
    transition: all 0.2s;
  }

  .tab-btn .tab-icon { font-size: 20px; margin-bottom: 2px; }
  .tab-btn .tab-label { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
  .tab-btn.active .tab-label { color: var(--accent); }
  .tab-btn.active .tab-icon { transform: scale(1.1); }

  /* ===== PAGES ===== */
  .page { display: none; flex: 1; overflow-y: auto; padding: 16px 16px calc(80px + var(--safe-bottom)); }
  .page.active { display: block; }

  /* ===== CARDS ===== */
  .card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 16px 18px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-card);
  }

  .card-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text3);
    margin-bottom: 12px;
  }

  /* ===== INPUTS ===== */
  .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
  .input-group { flex: 1; }
  .input-group.small { flex: 0 0 110px; }

  label {
    display: block;
    font-size: 11px;
    color: var(--text2);
    margin-bottom: 5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input[type="text"], input[type="number"], input[type="password"] {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px;
    font-size: 15px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }

  input:focus {
    border-color: var(--accent-light);
    box-shadow: 0 0 0 3px rgba(232,99,140,0.10);
  }

  input::placeholder { color: var(--text3); font-size: 13px; }

  /* ===== BUTTONS ===== */
  .btn-primary {
    width: 100%;
    background: var(--grad);
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 14px;
    font-size: 15px;
    font-weight: 800;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(232,99,140,0.25);
    transition: opacity 0.2s, transform 0.1s;
  }

  .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
  .btn-primary:disabled { background: var(--border); color: var(--text3); box-shadow: none; }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }

  /* ===== RESULT ===== */
  .result-card {
    background: linear-gradient(135deg, #fff5f9, #f5eeff);
    border: 1.5px solid var(--accent-light);
    border-radius: 18px;
    padding: 16px 18px;
    margin-bottom: 12px;
    display: none;
    animation: fadeIn 0.35s ease;
    box-shadow: var(--shadow);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .result-food { font-size: 16px; font-weight: 800; color: var(--text); }
  .result-grams { font-size: 12px; color: var(--text2); margin-top: 2px; }

  .fav-btn {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    padding: 2px;
    transition: transform 0.2s;
  }
  .fav-btn:active { transform: scale(1.3); }

  .stats-row { display: flex; gap: 8px; }

  .stat-box {
    flex: 1;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    text-align: center;
  }

  .stat-val { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 600; color: var(--accent2); }
  .stat-label { font-size: 9px; color: var(--text3); font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }

  .source-tag {
    display: inline-block;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 10px;
    color: var(--text2);
    font-family: 'DM Mono', monospace;
    margin-top: 10px;
  }

  /* ===== GRAMAJ AUTO ===== */
  .gramaj-auto-card {
    background: linear-gradient(135deg, #fff5f9, #f5f0ff);
    border: 1.5px solid var(--accent-light);
    border-radius: 12px;
    padding: 10px 14px;
    margin-bottom: 10px;
    font-size: 12px;
    color: var(--accent2);
    font-weight: 600;
    display: none;
    animation: fadeIn 0.3s ease;
  }

  /* ===== CONFIRM ===== */
  .confirm-card {
    background: linear-gradient(135deg, #fff5f9, #f9f0ff);
    border: 1.5px solid var(--accent-light);
    border-radius: 18px;
    padding: 16px 18px;
    margin-bottom: 12px;
    display: none;
    animation: fadeIn 0.3s ease;
    box-shadow: var(--shadow-card);
  }

  .confirm-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .confirm-subtitle { font-size: 12px; color: var(--text2); margin-bottom: 10px; line-height: 1.5; }

  .confirm-food-name {
    display: inline-block;
    background: var(--accent-soft);
    color: var(--accent);
    font-weight: 800;
    border-radius: 8px;
    padding: 5px 12px;
    font-size: 14px;
    margin-bottom: 12px;
  }

  .confirm-btns { display: flex; gap: 8px; }

  .btn-yes {
    flex: 1; background: var(--grad); color: #fff; border: none;
    border-radius: 10px; padding: 12px; font-size: 13px; font-weight: 700;
    font-family: 'Nunito', sans-serif; cursor: pointer;
  }

  .btn-no {
    flex: 1; background: var(--surface2); color: var(--text2);
    border: 1.5px solid var(--border); border-radius: 10px; padding: 12px;
    font-size: 13px; font-weight: 700; font-family: 'Nunito', sans-serif; cursor: pointer;
  }

  /* ===== WARNING ===== */
  .warning-card {
    border-radius: 12px; padding: 10px 14px; margin-bottom: 12px;
    font-size: 12px; line-height: 1.6; display: none; font-weight: 600;
  }
  .warning-card.warn-medium { background: rgba(244,132,95,0.08); border: 1.5px solid rgba(244,132,95,0.3); color: var(--warn); display: block; }
  .warning-card.warn-low { background: rgba(232,93,117,0.08); border: 1.5px solid rgba(232,93,117,0.3); color: var(--danger); display: block; }

  /* ===== LOADING ===== */
  .loading {
    display: none; text-align: center; padding: 20px;
    color: var(--text2); font-size: 13px; font-weight: 600;
  }

  .loading .dots span { display: inline-block; animation: bounce 1.2s infinite; font-size: 16px; }
  .loading .dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading .dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }

  /* ===== ERROR ===== */
  .error-msg {
    background: rgba(232,93,117,0.07); border: 1.5px solid rgba(232,93,117,0.25);
    border-radius: 8px; padding: 10px 13px; font-size: 12px; color: var(--danger);
    margin-top: 10px; display: none; font-weight: 600;
  }

  .gramaj-hint { font-size: 11px; color: var(--accent2); margin-top: 4px; font-weight: 600; font-style: italic; display: none; }

  /* ===== HISTORY ===== */
  .history-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 0; border-bottom: 1.5px solid var(--border);
  }
  .history-item:last-child { border-bottom: none; }
  .history-name { font-size: 14px; font-weight: 700; color: var(--text); }
  .history-details { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .history-insulin { font-family: 'DM Mono', monospace; color: var(--accent); font-weight: 700; font-size: 16px; }

  .empty-state { text-align: center; color: var(--text3); font-size: 13px; padding: 20px 0; font-weight: 600; }

  /* ===== FAVORITES ===== */
  .fav-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 0; border-bottom: 1.5px solid var(--border);
  }
  .fav-item:last-child { border-bottom: none; }
  .fav-name { font-size: 14px; font-weight: 700; color: var(--text); }
  .fav-details { font-size: 11px; color: var(--text2); margin-top: 2px; }

  .fav-actions { display: flex; gap: 8px; align-items: center; }

  .btn-use-fav {
    background: var(--grad); color: white; border: none;
    border-radius: 8px; padding: 6px 12px; font-size: 12px;
    font-weight: 700; font-family: 'Nunito', sans-serif; cursor: pointer;
  }

  .btn-del-fav {
    background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text3);
  }

  /* ===== SETTINGS ===== */
  .settings-label {
    font-size: 13px; font-weight: 700; color: var(--text2); margin-bottom: 8px;
  }

  .schema-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
  }

  .schema-row span { font-size: 13px; color: var(--text2); font-weight: 600; white-space: nowrap; }

  .schema-row input {
    width: 70px; text-align: center; padding: 8px;
  }

  .api-key-row { position: relative; }
  .api-key-row input { padding-right: 44px; }
  .toggle-key {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text2);
  }

  .save-btn-wrap { margin-top: 4px; }

  .success-msg {
    background: rgba(109,191,158,0.10); border: 1.5px solid rgba(109,191,158,0.4);
    border-radius: 8px; padding: 10px 13px; font-size: 12px; color: #3a9e78;
    margin-top: 10px; display: none; font-weight: 600; text-align: center;
  }

  /* ===== API KEY PROMPT ===== */
  .api-prompt {
    background: linear-gradient(135deg, #fff5f9, #f5eeff);
    border: 1.5px solid var(--accent-light);
    border-radius: 18px; padding: 20px; margin-bottom: 12px;
    text-align: center;
  }

  .api-prompt .api-icon { font-size: 36px; margin-bottom: 10px; }
  .api-prompt h3 { font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
  .api-prompt p { font-size: 12px; color: var(--text2); margin-bottom: 16px; line-height: 1.6; }
  .api-prompt a { color: var(--accent); font-weight: 700; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="app-header">
  <div class="header-top">
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <rect width="100" height="100" rx="22" fill="rgba(255,255,255,0.15)"/>
      <path d="M50 75 C50 75 20 55 20 37 C20 27 28 20 38 20 C43 20 48 23 50 27 C52 23 57 20 62 20 C72 20 80 27 80 37 C80 55 50 75 50 75Z" fill="none" stroke="white" stroke-width="6" stroke-linejoin="round"/>
    </svg>
    <div class="app-title">InsulinApp</div>
  </div>
  <div class="insulin-display">
    <div class="insulin-number" id="headerInsulin">‚Äî</div>
    <div class="insulin-label" id="headerLabel">unitƒÉ»õi insulinƒÉ üíâ</div>
  </div>
</div>

<!-- PAGE: CAUTƒÇ -->
<div class="page active" id="page-search">

  <div id="apiPrompt" class="api-prompt" style="display:none; margin-top:12px;">
    <div class="api-icon">üîë</div>
    <h3>AdaugƒÉ cheia API</h3>
    <p>Pentru a func»õiona, aplica»õia are nevoie de o cheie API Anthropic.<br>
    Ob»õine una gratuitƒÉ la <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> (prime»ôti $5 credit gratuit)</p>
    <button class="btn-primary" onclick="goToSettings()" style="margin-top:4px;">‚öôÔ∏è Mergi la SetƒÉri</button>
  </div>

  <div style="margin-top:12px;">
    <div class="card">
      <div class="input-row">
        <div class="input-group">
          <label>Aliment</label>
          <input type="text" id="foodInput" placeholder="ex: bananƒÉ, McPui»ôor..." autocomplete="off"/>
        </div>
        <div class="input-group small">
          <label>Grame</label>
          <input type="number" id="gramsInput" placeholder="auto" min="1" max="2000" inputmode="numeric"/>
          <div class="gramaj-hint" id="gramajHint">üí° LasƒÉ gol = caut eu</div>
        </div>
      </div>
      <div class="error-msg" id="errorMsg"></div>
      <button class="btn-primary" id="searchBtn" onclick="searchFood()">‚ú® CalculeazƒÉ</button>
    </div>

    <div class="loading" id="loading">
      <div class="dots"><span>üå∏</span><span>üå∏</span><span>üå∏</span></div>
      <p style="margin-top:8px">Caut informa»õii...</p>
    </div>

    <div class="confirm-card" id="confirmCard">
      <div class="confirm-title">üí≠ Vrei sƒÉ spui...</div>
      <div class="confirm-subtitle" id="confirmSubtitle"></div>
      <div class="confirm-food-name" id="confirmFoodName"></div>
      <div class="confirm-btns">
        <button class="btn-yes" onclick="confirmFood(true)">‚úÖ Da, asta e!</button>
        <button class="btn-no" onclick="confirmFood(false)">‚úèÔ∏è Nu, corectez</button>
      </div>
    </div>

    <div class="gramaj-auto-card" id="gramajAutoCard"></div>

    <div class="result-card" id="resultCard">
      <div class="result-header">
        <div>
          <div class="result-food" id="resultFood"></div>
          <div class="result-grams" id="resultGrams"></div>
        </div>
        <button class="fav-btn" id="favBtn" onclick="toggleFavorite()" title="AdaugƒÉ la favorite">ü§ç</button>
      </div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-val" id="resultHC"></div>
          <div class="stat-label">HC total</div>
        </div>
        <div class="stat-box">
          <div class="stat-val" id="resultHC100"></div>
          <div class="stat-label">HC / 100g</div>
        </div>
      </div>
      <div id="resultSource"></div>
    </div>

    <div class="warning-card" id="warningCard"></div>
  </div>
</div>

<!-- PAGE: ISTORIC -->
<div class="page" id="page-history">
  <div style="margin-top:12px;">
    <div class="card">
      <div class="card-title">üïê Istoric mese</div>
      <div id="historyList"><div class="empty-state">Niciun aliment calculat √ÆncƒÉ üå∏</div></div>
    </div>
    <button class="btn-secondary" style="width:100%;margin-top:4px;" onclick="clearHistory()">üóë »òterge istoricul</button>
  </div>
</div>

<!-- PAGE: FAVORITE -->
<div class="page" id="page-favorites">
  <div style="margin-top:12px;">
    <div class="card">
      <div class="card-title">‚≠ê Alimentele mele favorite</div>
      <div id="favoritesList"><div class="empty-state">Niciun favorit salvat √ÆncƒÉ<br>ApasƒÉ ü§ç dupƒÉ calcul pentru a salva! üå∏</div></div>
    </div>
  </div>
</div>

<!-- PAGE: SETƒÇRI -->
<div class="page" id="page-settings">
  <div style="margin-top:12px;">

    <!-- API KEY -->
    <div class="card">
      <div class="card-title">üîë Cheie API Anthropic</div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6;">
        Ob»õine cheia de la <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);font-weight:700;">console.anthropic.com</a>.<br>
        Se salveazƒÉ pe telefon, nu e trimisƒÉ nimƒÉnui altcuiva.
      </p>
      <label>Cheia API</label>
      <div class="api-key-row">
        <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off"/>
        <button class="toggle-key" onclick="toggleKeyVisibility()">üëÅ</button>
      </div>
      <div class="save-btn-wrap" style="margin-top:10px;">
        <button class="btn-primary" onclick="saveApiKey()">üíæ SalveazƒÉ cheia</button>
      </div>
      <div class="success-msg" id="apiSuccess">‚úÖ Cheia a fost salvatƒÉ!</div>
    </div>

    <!-- SCHEMA INSULINƒÇ -->
    <div class="card">
      <div class="card-title">üíâ Schema mea de insulinƒÉ</div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.6;">
        ModificƒÉ raportul tƒÉu HC ‚Üí unitƒÉ»õi. Formula: la fiecare <strong id="perDisplay">10</strong>g HC faci <strong id="ratioDisplay">2</strong> unitƒÉ»õi.
      </p>

      <div class="schema-row">
        <span>La fiecare</span>
        <input type="number" id="schemaPer" value="10" min="1" max="50" inputmode="numeric"/>
        <span>g HC ‚Üí</span>
        <input type="number" id="schemaRatio" value="2" min="0.5" max="10" step="0.5" inputmode="decimal"/>
        <span>unitƒÉ»õi</span>
      </div>

      <div class="card" style="background:var(--surface2);margin-bottom:0;padding:12px;">
        <div class="card-title" style="margin-bottom:8px;">Previzualizare schemƒÉ</div>
        <div id="schemaPreview" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;"></div>
      </div>

      <div style="margin-top:10px;">
        <button class="btn-primary" onclick="saveSchema()">üíæ SalveazƒÉ schema</button>
      </div>
      <div class="success-msg" id="schemaSuccess">‚úÖ Schema a fost salvatƒÉ!</div>
    </div>

  </div>
</div>

<!-- TAB BAR -->
<div class="tab-bar">
  <button class="tab-btn active" id="tab-search" onclick="switchTab('search')">
    <span class="tab-icon">üîç</span>
    <span class="tab-label">CautƒÉ</span>
  </button>
  <button class="tab-btn" id="tab-history" onclick="switchTab('history')">
    <span class="tab-icon">üïê</span>
    <span class="tab-label">Istoric</span>
  </button>
  <button class="tab-btn" id="tab-favorites" onclick="switchTab('favorites')">
    <span class="tab-icon">‚≠ê</span>
    <span class="tab-label">Favorite</span>
  </button>
  <button class="tab-btn" id="tab-settings" onclick="switchTab('settings')">
    <span class="tab-icon">‚öôÔ∏è</span>
    <span class="tab-label">SetƒÉri</span>
  </button>
</div>

<script>
// ===== STATE =====
let pendingFood = null, pendingGrams = null, confirmedFoodName = null;
let currentResult = null;

// ===== STORAGE HELPERS =====
function load(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch { return def; }
}
function save(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
}

// ===== SCHEMA =====
let schema = load('insulinSchema', { per: 10, ratio: 2 });

function calculateInsulin(hc) {
  return Math.round((hc / schema.per) * schema.ratio * 2) / 2;
}

function renderSchemaPreview() {
  const per = parseFloat(document.getElementById('schemaPer').value) || 10;
  const ratio = parseFloat(document.getElementById('schemaRatio').value) || 2;
  document.getElementById('perDisplay').textContent = per;
  document.getElementById('ratioDisplay').textContent = ratio;
  const preview = document.getElementById('schemaPreview');
  let html = '';
  for (let i = 2; i <= 10; i++) {
    const hc = per * i;
    const units = ratio * i;
    html += `<div style="background:white;border:1.5px solid var(--border);border-radius:8px;padding:6px 10px;display:flex;justify-content:space-between;font-size:12px;font-weight:600;">
      <span style="color:var(--text2)">${hc}g HC</span>
      <span style="color:var(--accent);font-family:'DM Mono',monospace">${units} u</span>
    </div>`;
  }
  preview.innerHTML = html;
}

function saveSchema() {
  schema.per = parseFloat(document.getElementById('schemaPer').value) || 10;
  schema.ratio = parseFloat(document.getElementById('schemaRatio').value) || 2;
  save('insulinSchema', schema);
  document.getElementById('schemaSuccess').style.display = 'block';
  setTimeout(() => document.getElementById('schemaSuccess').style.display = 'none', 2500);
}

document.getElementById('schemaPer').addEventListener('input', renderSchemaPreview);
document.getElementById('schemaRatio').addEventListener('input', renderSchemaPreview);

// ===== API KEY =====
function getApiKey() { return load('apiKey', ''); }

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { alert('Te rog introdu cheia API!'); return; }
  save('apiKey', key);
  document.getElementById('apiSuccess').style.display = 'block';
  document.getElementById('apiPrompt').style.display = 'none';
  setTimeout(() => document.getElementById('apiSuccess').style.display = 'none', 2500);
}

function toggleKeyVisibility() {
  const inp = document.getElementById('apiKeyInput');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function goToSettings() { switchTab('settings'); }

// ===== HISTORY =====
let historyData = load('mealHistory', []);

function saveHistory() { save('mealHistory', historyData); }

function renderHistory() {
  const list = document.getElementById('historyList');
  if (!historyData.length) { list.innerHTML = '<div class="empty-state">Niciun aliment calculat √ÆncƒÉ üå∏</div>'; return; }
  list.innerHTML = historyData.map((h, i) => `
    <div class="history-item">
      <div>
        <div class="history-name">${h.food}</div>
        <div class="history-details">${h.grams}g &bull; ${h.hc}g HC &bull; ${h.time}</div>
      </div>
      <div class="history-insulin">${h.insulin} u üíâ</div>
    </div>
  `).join('');
}

function clearHistory() {
  if (confirm('»òtergi tot istoricul?')) {
    historyData = [];
    saveHistory();
    renderHistory();
  }
}

// ===== FAVORITES =====
let favoritesData = load('favorites', []);

function saveFavorites() { save('favorites', favoritesData); }

function renderFavorites() {
  const list = document.getElementById('favoritesList');
  if (!favoritesData.length) {
    list.innerHTML = '<div class="empty-state">Niciun favorit salvat √ÆncƒÉ<br>ApasƒÉ ü§ç dupƒÉ calcul pentru a salva! üå∏</div>';
    return;
  }
  list.innerHTML = favoritesData.map((f, i) => `
    <div class="fav-item">
      <div>
        <div class="fav-name">${f.food}</div>
        <div class="fav-details">${f.grams}g &bull; ${f.hc}g HC &bull; ${f.insulin} u</div>
      </div>
      <div class="fav-actions">
        <button class="btn-use-fav" onclick="useFavorite(${i})">CalculeazƒÉ</button>
        <button class="btn-del-fav" onclick="deleteFavorite(${i})">üóë</button>
      </div>
    </div>
  `).join('');
}

function toggleFavorite() {
  if (!currentResult) return;
  const food = document.getElementById('resultFood').textContent;
  const grams = document.getElementById('resultGrams').textContent.replace('g', '');
  const hc = document.getElementById('resultHC').textContent.replace('g', '');
  const insulin = document.getElementById('headerInsulin').textContent;
  const idx = favoritesData.findIndex(f => f.food === food && f.grams === grams);
  if (idx >= 0) {
    favoritesData.splice(idx, 1);
    document.getElementById('favBtn').textContent = 'ü§ç';
  } else {
    favoritesData.unshift({ food, grams, hc, insulin });
    document.getElementById('favBtn').textContent = '‚ù§Ô∏è';
  }
  saveFavorites();
  renderFavorites();
}

function useFavorite(i) {
  const f = favoritesData[i];
  document.getElementById('foodInput').value = f.food;
  document.getElementById('gramsInput').value = f.grams;
  switchTab('search');
  searchFood();
}

function deleteFavorite(i) {
  favoritesData.splice(i, 1);
  saveFavorites();
  renderFavorites();
}

// ===== TABS =====
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

// ===== SEARCH =====
async function searchFood() {
  const apiKey = getApiKey();
  if (!apiKey) {
    document.getElementById('apiPrompt').style.display = 'block';
    return;
  }

  const food = document.getElementById('foodInput').value.trim();
  const gramsRaw = document.getElementById('gramsInput').value;
  const grams = gramsRaw ? parseFloat(gramsRaw) : null;
  const errorMsg = document.getElementById('errorMsg');
  errorMsg.style.display = 'none';

  if (!food) { errorMsg.textContent = 'Te rog introdu numele alimentului.'; errorMsg.style.display = 'block'; return; }
  if (grams !== null && grams <= 0) { errorMsg.textContent = 'Te rog introdu o cantitate validƒÉ.'; errorMsg.style.display = 'block'; return; }

  pendingFood = food; pendingGrams = grams; confirmedFoodName = null;
  currentResult = null;

  document.getElementById('loading').style.display = 'block';
  document.getElementById('resultCard').style.display = 'none';
  document.getElementById('warningCard').className = 'warning-card';
  document.getElementById('confirmCard').style.display = 'none';
  document.getElementById('gramajAutoCard').style.display = 'none';
  document.getElementById('searchBtn').disabled = true;
  document.getElementById('headerInsulin').textContent = '‚Äî';

  const gramsInfo = grams
    ? `Cantitate: ${grams}g`
    : `Cantitate: necunoscutƒÉ ‚Äî cautƒÉ gramajul tipic al acestui produs`;

  try {
    const response = await fetch("https://corsproxy.io/?https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-allow-browser": "true",
        "Access-Control-Allow-Origin": "*"
      },
      body: JSON.stringify({
        model: "claude-haiku-4-5-20251001",
        max_tokens: 1000,
        system: `E»ôti un asistent specializat √Æn nutri»õie pentru diabetici din Rom√¢nia.
Cuno»ôti: calorii.oneden.com, meniurile McDonald's Romania, KFC Romania, Burger King, Pizza Hut, Subway, produse ambalate din Rom√¢nia, valori nutritive standard.
DacƒÉ nu gƒÉse»ôti informa»õii clare, spune explicit cƒÉ nu po»õi calcula √Æn loc sƒÉ estimezi valori nesigure.
RƒÉspunde DOAR cu JSON valid, fƒÉrƒÉ markdown:
{"necesita_confirmare":bool,"nume_corectat":"str sau null","mesaj_confirmare":"str sau null","gramaj_auto":num sau null,"gramaj_auto_sursa":"str sau null","gramaj_auto_nota":"str sau null","carbohidrati_100g":num,"carbohidrati_total":num,"sursa":"str","siguranta":"ridicata|medie|scazuta","observatie":"str sau null","negasit":bool}
DacƒÉ nu gƒÉse»ôti informa»õii: negasit=true, carbohidrati_100g=0, carbohidrati_total=0.`,
        messages: [{ role: "user", content: `Aliment: ${food}\n${gramsInfo}` }]
      })
    });

    const data = await response.json();

    if (data.error) {
      throw new Error('API: ' + (data.error.message || JSON.stringify(data.error)));
    }

    const text = data.content.map(i => i.text || "").join("");
    const clean = text.replace(/```json|```/g, "").trim();
    const result = JSON.parse(clean);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('searchBtn').disabled = false;

    if (result.negasit) {
      errorMsg.textContent = '‚ùå Nu am gƒÉsit informa»õii pentru acest aliment. √éncearcƒÉ un nume mai specific.';
      errorMsg.style.display = 'block';
      document.getElementById('headerInsulin').textContent = '‚Äî';
      return;
    }

    const finalGrams = grams || result.gramaj_auto;

    if (result.necesita_confirmare && result.nume_corectat) {
      confirmedFoodName = result.nume_corectat;
      document.getElementById('confirmSubtitle').textContent = result.mesaj_confirmare || 'Am identificat alimentul ca:';
      document.getElementById('confirmFoodName').textContent = result.nume_corectat;
      document.getElementById('confirmCard').style.display = 'block';
      window._pendingResult = result;
      window._finalGrams = finalGrams;
    } else {
      showResult(result, food, finalGrams);
    }

  } catch (err) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('searchBtn').disabled = false;
    if (err.message && err.message.includes('401')) {
      errorMsg.textContent = 'üîë Cheia API este invalidƒÉ. VerificƒÉ √Æn SetƒÉri.';
    } else if (err.message && err.message.includes('Failed to fetch')) {
      errorMsg.textContent = '‚ùå Browserul blocheazƒÉ conexiunea. √éncearcƒÉ sƒÉ deschizi aplica»õia direct √Æn Chrome (nu ca PWA instalatƒÉ).';
    } else {
      errorMsg.textContent = '‚ùå ' + (err.message || 'Eroare necunoscutƒÉ. VerificƒÉ internetul.');
    }
    errorMsg.style.display = 'block';
  }
}

function confirmFood(yes) {
  document.getElementById('confirmCard').style.display = 'none';
  if (yes && window._pendingResult) {
    showResult(window._pendingResult, confirmedFoodName || pendingFood, window._finalGrams);
  } else {
    document.getElementById('foodInput').focus();
    document.getElementById('foodInput').select();
  }
}

function showResult(result, foodName, grams) {
  const hc = result.carbohidrati_total;
  const hc100 = result.carbohidrati_100g;
  const insulin = calculateInsulin(hc);

  currentResult = { foodName, grams, hc, hc100, insulin };

  if (!pendingGrams && result.gramaj_auto) {
    const autoCard = document.getElementById('gramajAutoCard');
    autoCard.textContent = `üí° ${result.gramaj_auto_nota || `Gramaj tipic: ${result.gramaj_auto}g`} (${result.gramaj_auto_sursa || 'estimare'})`;
    autoCard.style.display = 'block';
  }

  document.getElementById('resultFood').textContent = foodName.charAt(0).toUpperCase() + foodName.slice(1);
  document.getElementById('resultGrams').textContent = `${grams}g`;
  document.getElementById('resultHC').textContent = `${hc.toFixed(1)}g`;
  document.getElementById('resultHC100').textContent = `${hc100}g`;
  document.getElementById('resultSource').innerHTML = `<span class="source-tag">üìä ${result.sursa}</span>`;
  document.getElementById('resultCard').style.display = 'block';
  document.getElementById('favBtn').textContent = 'ü§ç';

  // Update header
  document.getElementById('headerInsulin').textContent = insulin;

  // Warning
  const warnCard = document.getElementById('warningCard');
  warnCard.className = 'warning-card';
  if (result.siguranta === 'scazuta') {
    warnCard.textContent = `‚ö†Ô∏è ${result.observatie || 'Valorile pot varia. VerificƒÉ cu producƒÉtorul.'}`;
    warnCard.classList.add('warn-low');
  } else if (result.siguranta === 'medie') {
    warnCard.textContent = `‚ÑπÔ∏è ${result.observatie || 'Valorile sunt estimative.'}`;
    warnCard.classList.add('warn-medium');
  }

  // Add to history
  const now = new Date();
  const time = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
  historyData.unshift({ food: foodName, grams, hc: hc.toFixed(1), insulin, time });
  if (historyData.length > 30) historyData.pop();
  saveHistory();
  renderHistory();
}

// ===== INIT =====
function init() {
  // Load schema inputs
  document.getElementById('schemaPer').value = schema.per;
  document.getElementById('schemaRatio').value = schema.ratio;
  renderSchemaPreview();

  // Load API key
  const key = getApiKey();
  if (key) {
    document.getElementById('apiKeyInput').value = key;
  } else {
    document.getElementById('apiPrompt').style.display = 'block';
  }

  renderHistory();
  renderFavorites();

  // Input hints
  const gramsInput = document.getElementById('gramsInput');
  gramsInput.addEventListener('focus', () => document.getElementById('gramajHint').style.display = 'block');
  gramsInput.addEventListener('input', () => {
    document.getElementById('gramajHint').style.display = gramsInput.value ? 'none' : 'block';
  });

  document.getElementById('foodInput').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('gramsInput').focus(); });
  document.getElementById('gramsInput').addEventListener('keydown', e => { if (e.key === 'Enter') searchFood(); });
}

init();

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>

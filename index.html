<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#e8638c">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="InsulinƒÉ üíó">
<title>Calculator InsulinƒÉ üíó</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon.svg">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fdf6f9;
    --surface: #ffffff;
    --surface2: #fef0f5;
    --border: #f5d6e5;
    --accent: #e8638c;
    --accent-light: #f9a8c4;
    --accent2: #b06ab3;
    --accent-soft: #fce4ec;
    --warn: #f4845f;
    --danger: #e85d75;
    --text: #3a2040;
    --text2: #8e6b80;
    --text3: #c9a8bb;
    --shadow: 0 4px 24px rgba(232,99,140,0.10);
    --shadow-card: 0 2px 12px rgba(176,106,179,0.08);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    overscroll-behavior: none;
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: calc(16px + var(--safe-top)) 16px calc(60px + var(--safe-bottom));
  }

  body::before {
    content: '';
    position: fixed;
    top: -80px; right: -80px;
    width: 280px; height: 280px;
    background: radial-gradient(circle, rgba(232,99,140,0.10) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -60px; left: -60px;
    width: 220px; height: 220px;
    background: radial-gradient(circle, rgba(176,106,179,0.08) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }

  .header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
    padding-top: 4px;
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 440px;
  }

  .header .icon { font-size: 28px; }

  .header h1 {
    font-size: 20px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p { font-size: 12px; color: var(--text2); }

  .card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 16px 18px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-card);
    position: relative;
    z-index: 1;
  }

  .card-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text3);
    margin-bottom: 12px;
  }

  .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
  .input-group { flex: 1; }
  .input-group.small { flex: 0 0 120px; }

  label {
    display: block;
    font-size: 11px;
    color: var(--text2);
    margin-bottom: 5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px 13px;
    font-size: 16px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }

  input:focus {
    border-color: var(--accent-light);
    box-shadow: 0 0 0 3px rgba(232,99,140,0.10);
  }

  input::placeholder { color: var(--text3); font-size: 13px; }

  .gramaj-hint {
    font-size: 11px;
    color: var(--accent2);
    margin-top: 4px;
    font-weight: 600;
    font-style: italic;
    display: none;
  }

  .btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 15px;
    font-size: 16px;
    font-weight: 800;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
    box-shadow: 0 3px 12px rgba(232,99,140,0.25);
    -webkit-appearance: none;
  }

  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn:disabled { background: var(--border); color: var(--text3); cursor: not-allowed; box-shadow: none; }

  /* RESULT */
  .result-card {
    background: var(--surface);
    border: 1.5px solid var(--accent-light);
    border-radius: 18px;
    padding: 16px 18px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    display: none;
    animation: fadeIn 0.35s ease;
    box-shadow: var(--shadow);
    position: relative;
    z-index: 1;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .result-food-info .result-food { font-size: 16px; font-weight: 800; color: var(--text); }
  .result-food-info .result-grams { font-size: 12px; color: var(--text2); margin-top: 2px; font-weight: 500; }

  .insulin-badge {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 14px;
    padding: 8px 16px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(232,99,140,0.25);
    min-width: 80px;
  }

  .insulin-badge .ins-num {
    font-family: 'DM Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    line-height: 1;
  }

  .insulin-badge .ins-label {
    font-size: 10px;
    color: rgba(255,255,255,0.8);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  .stats-row { display: flex; gap: 8px; margin-top: 4px; }

  .stat-box {
    flex: 1;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    text-align: center;
  }

  .stat-box .stat-val {
    font-family: 'DM Mono', monospace;
    font-size: 15px;
    font-weight: 600;
    color: var(--accent2);
  }

  .stat-box .stat-label {
    font-size: 10px;
    color: var(--text3);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-top: 2px;
  }

  .source-tag {
    display: inline-block;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 10px;
    color: var(--text2);
    font-family: 'DM Mono', monospace;
    margin-top: 10px;
  }

  .gramaj-auto-card {
    background: linear-gradient(135deg, #fff5f9, #f5f0ff);
    border: 1.5px solid var(--accent-light);
    border-radius: 12px;
    padding: 10px 14px;
    margin-bottom: 10px;
    font-size: 12px;
    color: var(--accent2);
    font-weight: 600;
    display: none;
    animation: fadeIn 0.3s ease;
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 440px;
  }

  .confirm-card {
    background: linear-gradient(135deg, #fff5f9, #f9f0ff);
    border: 1.5px solid var(--accent-light);
    border-radius: 18px;
    padding: 16px 18px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    display: none;
    animation: fadeIn 0.3s ease;
    position: relative;
    z-index: 1;
    box-shadow: var(--shadow-card);
  }

  .confirm-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .confirm-subtitle { font-size: 12px; color: var(--text2); margin-bottom: 10px; line-height: 1.5; }

  .confirm-food-name {
    display: inline-block;
    background: var(--accent-soft);
    color: var(--accent);
    font-weight: 800;
    border-radius: 8px;
    padding: 5px 12px;
    font-size: 14px;
    margin-bottom: 12px;
  }

  .confirm-btns { display: flex; gap: 8px; }

  .btn-yes {
    flex: 1;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 13px;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }

  .btn-no {
    flex: 1;
    background: var(--surface2);
    color: var(--text2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }

  .warning-card {
    border-radius: 12px;
    padding: 10px 14px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    font-size: 12px;
    line-height: 1.6;
    display: none;
    font-weight: 600;
    position: relative;
    z-index: 1;
  }

  .warning-card.warn-medium { background: rgba(244,132,95,0.08); border: 1.5px solid rgba(244,132,95,0.3); color: var(--warn); display: block; }
  .warning-card.warn-low { background: rgba(232,93,117,0.08); border: 1.5px solid rgba(232,93,117,0.3); color: var(--danger); display: block; }

  .loading {
    display: none;
    text-align: center;
    padding: 16px;
    color: var(--text2);
    font-size: 13px;
    width: 100%;
    max-width: 440px;
    position: relative;
    z-index: 1;
    font-weight: 600;
  }

  .loading .dots span { display: inline-block; animation: bounce 1.2s infinite; font-size: 16px; }
  .loading .dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading .dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }

  .schema-toggle {
    width: 100%;
    background: none;
    border: none;
    font-family: 'Nunito', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text3);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0;
  }

  .schema-toggle.open { margin-bottom: 12px; }
  .schema-toggle .arrow { transition: transform 0.2s; font-size: 12px; }
  .schema-toggle.open .arrow { transform: rotate(180deg); }

  .schema-grid { display: none; grid-template-columns: 1fr 1fr; gap: 6px; }
  .schema-grid.open { display: grid; }

  .schema-item {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 7px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    font-weight: 600;
  }

  .schema-item .hc-val { color: var(--text2); }
  .schema-item .ins-val { color: var(--accent); font-family: 'DM Mono', monospace; font-weight: 700; }

  .history-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 16px 18px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-card);
    position: relative;
    z-index: 1;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1.5px solid var(--border);
    font-size: 12px;
  }

  .history-item:last-child { border-bottom: none; }
  .history-name { color: var(--text); font-weight: 700; font-size: 13px; }
  .history-details { color: var(--text2); font-size: 11px; margin-top: 1px; font-weight: 500; }
  .history-insulin { font-family: 'DM Mono', monospace; color: var(--accent); font-weight: 700; font-size: 14px; }

  .empty-history { text-align: center; color: var(--text3); font-size: 12px; padding: 8px 0; font-weight: 600; }

  .error-msg {
    background: rgba(232,93,117,0.07);
    border: 1.5px solid rgba(232,93,117,0.25);
    border-radius: 8px;
    padding: 10px 13px;
    font-size: 12px;
    color: var(--danger);
    margin-top: 10px;
    display: none;
    font-weight: 600;
  }

  /* INSTALL BANNER */
  .install-banner {
    background: linear-gradient(135deg, var(--accent-soft), #f0e8ff);
    border: 1.5px solid var(--accent-light);
    border-radius: 14px;
    padding: 12px 16px;
    width: 100%;
    max-width: 440px;
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .install-banner .install-title {
    font-size: 13px;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .install-banner .install-text {
    font-size: 12px;
    color: var(--text2);
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .install-banner .btn-install {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Nunito', sans-serif;
    cursor: pointer;
  }

  .install-banner .btn-close {
    position: absolute;
    top: 10px; right: 12px;
    background: none;
    border: none;
    font-size: 16px;
    color: var(--text3);
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <button class="btn-close" onclick="closeInstall()">‚úï</button>
  <div class="install-title">üì≤ InstaleazƒÉ aplica»õia!</div>
  <div class="install-text">AdaugƒÉ pe ecranul de acasƒÉ pentru acces rapid, fƒÉrƒÉ browser.</div>
  <button class="btn-install" id="installBtn">‚¨áÔ∏è InstaleazƒÉ</button>
</div>

<div class="header">
  <span class="icon">üå∏</span>
  <div>
    <h1>Calculator InsulinƒÉ</h1>
    <p>Carbohidra»õi & unitƒÉ»õi üíó</p>
  </div>
</div>

<div class="card">
  <div class="input-row">
    <div class="input-group">
      <label>Aliment</label>
      <input type="text" id="foodInput" placeholder="ex: orez, McPui»ôor..." autocomplete="off" />
    </div>
    <div class="input-group small">
      <label>Grame</label>
      <input type="number" id="gramsInput" placeholder="auto" min="1" max="2000" inputmode="numeric" />
      <div class="gramaj-hint" id="gramajHint">üí° LasƒÉ gol = caut eu</div>
    </div>
  </div>
  <div class="error-msg" id="errorMsg"></div>
  <button class="btn" id="searchBtn" onclick="searchFood()">‚ú® CalculeazƒÉ</button>
</div>

<div class="loading" id="loading">
  <div class="dots"><span>üå∏</span><span>üå∏</span><span>üå∏</span></div>
  <p style="margin-top:8px">Caut informa»õii...</p>
</div>

<div class="confirm-card" id="confirmCard">
  <div class="confirm-title">üí≠ Vrei sƒÉ spui...</div>
  <div class="confirm-subtitle" id="confirmSubtitle"></div>
  <div class="confirm-food-name" id="confirmFoodName"></div>
  <div class="confirm-btns">
    <button class="btn-yes" onclick="confirmFood(true)">‚úÖ Da, asta e!</button>
    <button class="btn-no" onclick="confirmFood(false)">‚úèÔ∏è Nu, corectez</button>
  </div>
</div>

<div class="gramaj-auto-card" id="gramajAutoCard"></div>

<div class="result-card" id="resultCard">
  <div class="result-header">
    <div class="result-food-info">
      <div class="result-food" id="resultFood"></div>
      <div class="result-grams" id="resultGrams"></div>
    </div>
    <div class="insulin-badge">
      <div class="ins-num" id="resultInsulin"></div>
      <div class="ins-label">unitƒÉ»õi üíâ</div>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-val" id="resultHC"></div>
      <div class="stat-label">HC total</div>
    </div>
    <div class="stat-box">
      <div class="stat-val" id="resultHC100"></div>
      <div class="stat-label">HC / 100g</div>
    </div>
  </div>
  <div id="resultSource"></div>
</div>

<div class="warning-card" id="warningCard"></div>

<div class="card">
  <button class="schema-toggle" id="schemaToggle" onclick="toggleSchema()">
    <span>üíâ Schema mea de insulinƒÉ</span>
    <span class="arrow">‚ñº</span>
  </button>
  <div class="schema-grid" id="schemaGrid">
    <div class="schema-item"><span class="hc-val">20g HC</span><span class="ins-val">4 u</span></div>
    <div class="schema-item"><span class="hc-val">30g HC</span><span class="ins-val">6 u</span></div>
    <div class="schema-item"><span class="hc-val">40g HC</span><span class="ins-val">8 u</span></div>
    <div class="schema-item"><span class="hc-val">50g HC</span><span class="ins-val">10 u</span></div>
    <div class="schema-item"><span class="hc-val">60g HC</span><span class="ins-val">12 u</span></div>
    <div class="schema-item"><span class="hc-val">70g HC</span><span class="ins-val">14 u</span></div>
    <div class="schema-item"><span class="hc-val">80g HC</span><span class="ins-val">16 u</span></div>
    <div class="schema-item"><span class="hc-val">90g HC</span><span class="ins-val">18 u</span></div>
  </div>
</div>

<div class="history-card">
  <div class="card-title">üïê Istoric azi</div>
  <div id="historyList"><div class="empty-history">Niciun aliment calculat √ÆncƒÉ üå∏</div></div>
</div>

<script>
// PWA: Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// PWA: Install prompt
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').style.display = 'block';
});

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').style.display = 'none';
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    if (outcome === 'accepted') {
      document.getElementById('installBanner').style.display = 'none';
    }
  }
});

function closeInstall() {
  document.getElementById('installBanner').style.display = 'none';
}

// APP LOGIC
let history = [];
let pendingFood = null;
let pendingGrams = null;
let confirmedFoodName = null;

function toggleSchema() {
  const grid = document.getElementById('schemaGrid');
  const toggle = document.getElementById('schemaToggle');
  grid.classList.toggle('open');
  toggle.classList.toggle('open');
}

const gramsInput = document.getElementById('gramsInput');
gramsInput.addEventListener('focus', () => {
  document.getElementById('gramajHint').style.display = 'block';
});
gramsInput.addEventListener('input', () => {
  document.getElementById('gramajHint').style.display = gramsInput.value ? 'none' : 'block';
});

function calculateInsulin(hc) {
  return Math.round((hc / 10) * 2 * 2) / 2;
}

async function searchFood() {
  const food = document.getElementById('foodInput').value.trim();
  const gramsRaw = document.getElementById('gramsInput').value;
  const grams = gramsRaw ? parseFloat(gramsRaw) : null;
  const errorMsg = document.getElementById('errorMsg');
  errorMsg.style.display = 'none';

  if (!food) { errorMsg.textContent = 'Te rog introdu numele alimentului.'; errorMsg.style.display = 'block'; return; }
  if (grams !== null && grams <= 0) { errorMsg.textContent = 'Te rog introdu o cantitate validƒÉ.'; errorMsg.style.display = 'block'; return; }

  pendingFood = food;
  pendingGrams = grams;
  confirmedFoodName = null;

  document.getElementById('loading').style.display = 'block';
  document.getElementById('resultCard').style.display = 'none';
  document.getElementById('warningCard').className = 'warning-card';
  document.getElementById('confirmCard').style.display = 'none';
  document.getElementById('gramajAutoCard').style.display = 'none';
  document.getElementById('searchBtn').disabled = true;

  const gramsInfo = grams
    ? `Cantitate: ${grams}g`
    : `Cantitate: necunoscutƒÉ ‚Äî cautƒÉ gramajul tipic al acestui produs (meniu restaurant, ambalaj standard etc.)`;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1200,
        system: `E»ôti un asistent specializat √Æn nutri»õie pentru diabetici din Rom√¢nia.
Cuno»ôti: calorii.oneden.com, meniurile McDonald's Romania, KFC Romania, Burger King, Pizza Hut, Subway, Taco Bell, produse ambalate din Rom√¢nia, valori nutritive standard.

C√¢nd prime»ôti un aliment:
1. DacƒÉ e scris gre»ôit/prescurtat, identificƒÉ-l
2. DacƒÉ gramajul e necunoscut, cautƒÉ gramajul tipic/oficial
3. CalculeazƒÉ carbohidra»õii

RƒÉspunde DOAR cu JSON valid, fƒÉrƒÉ markdown:
{"necesita_confirmare":bool,"nume_corectat":"str sau null","mesaj_confirmare":"str sau null","gramaj_auto":num sau null,"gramaj_auto_sursa":"str sau null","gramaj_auto_nota":"str sau null","carbohidrati_100g":num,"carbohidrati_total":num,"sursa":"str","siguranta":"ridicata|medie|scazuta","observatie":"str sau null"}`,
        messages: [{ role: "user", content: `Aliment: ${food}\n${gramsInfo}` }]
      })
    });

    const data = await response.json();
    const text = data.content.map(i => i.text || "").join("");
    const clean = text.replace(/```json|```/g, "").trim();
    const result = JSON.parse(clean);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('searchBtn').disabled = false;

    const finalGrams = grams || result.gramaj_auto;

    if (result.necesita_confirmare && result.nume_corectat) {
      confirmedFoodName = result.nume_corectat;
      document.getElementById('confirmSubtitle').textContent = result.mesaj_confirmare || 'Am identificat alimentul ca:';
      document.getElementById('confirmFoodName').textContent = result.nume_corectat;
      document.getElementById('confirmCard').style.display = 'block';
      window._pendingResult = result;
      window._finalGrams = finalGrams;
    } else {
      showResult(result, food, finalGrams);
    }

  } catch (err) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('errorMsg').textContent = 'Eroare de conexiune. √éncearcƒÉ din nou.';
    document.getElementById('errorMsg').style.display = 'block';
  }
}

function confirmFood(yes) {
  document.getElementById('confirmCard').style.display = 'none';
  if (yes && window._pendingResult) {
    showResult(window._pendingResult, confirmedFoodName || pendingFood, window._finalGrams);
  } else {
    document.getElementById('foodInput').focus();
    document.getElementById('foodInput').select();
  }
}

function showResult(result, foodName, grams) {
  const hc = result.carbohidrati_total;
  const hc100 = result.carbohidrati_100g;
  const insulin = calculateInsulin(hc);

  if (!pendingGrams && result.gramaj_auto) {
    const autoCard = document.getElementById('gramajAutoCard');
    autoCard.textContent = `üí° ${result.gramaj_auto_nota || `Gramaj tipic: ${result.gramaj_auto}g`} (${result.gramaj_auto_sursa || 'estimare'})`;
    autoCard.style.display = 'block';
  }

  document.getElementById('resultFood').textContent = foodName.charAt(0).toUpperCase() + foodName.slice(1);
  document.getElementById('resultGrams').textContent = `${grams}g`;
  document.getElementById('resultHC').textContent = `${hc.toFixed(1)}g`;
  document.getElementById('resultHC100').textContent = `${hc100}g`;
  document.getElementById('resultInsulin').textContent = insulin;
  document.getElementById('resultSource').innerHTML = `<span class="source-tag">üìä ${result.sursa}</span>`;
  document.getElementById('resultCard').style.display = 'block';

  const warnCard = document.getElementById('warningCard');
  warnCard.className = 'warning-card';
  if (result.siguranta === 'scazuta') {
    warnCard.textContent = `‚ö†Ô∏è ${result.observatie || 'Valorile pot varia. VerificƒÉ cu producƒÉtorul.'}`;
    warnCard.classList.add('warn-low');
  } else if (result.siguranta === 'medie') {
    warnCard.textContent = `‚ÑπÔ∏è ${result.observatie || 'Valorile sunt estimative.'}`;
    warnCard.classList.add('warn-medium');
  }

  history.unshift({ food: foodName, grams, hc: hc.toFixed(1), insulin });
  if (history.length > 5) history.pop();
  updateHistory();
}

function updateHistory() {
  const list = document.getElementById('historyList');
  if (!history.length) { list.innerHTML = '<div class="empty-history">Niciun aliment calculat √ÆncƒÉ üå∏</div>'; return; }
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div>
        <div class="history-name">${h.food}</div>
        <div class="history-details">${h.grams}g &bull; ${h.hc}g HC</div>
      </div>
      <div class="history-insulin">${h.insulin} u üíâ</div>
    </div>
  `).join('');
}

document.getElementById('foodInput').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('gramsInput').focus(); });
document.getElementById('gramsInput').addEventListener('keydown', e => { if (e.key === 'Enter') searchFood(); });
</script>
</body>
</html>
